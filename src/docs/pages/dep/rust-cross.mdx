# 交叉编译新版本rustc

### 0.准备工作
*   本机需要安装`ninja`
*   在远程机上,下载安装`openssl-devel`、~~`libstdc++-devel`~~、`glibc-devel`。
*   需要准备x86到LoongArch旧世界的交叉工具链，但这个编译时很容易缺依赖，你可以用CoA打包的交叉编译工具链。里面补足了rust所需要的库
*   本机需要安装一份夜版的rustc。建议在克隆仓库的同一天更新一次。

### 1.获得可用源码镜像
*   直接从仓库克隆即可  `git clone --depth=1 https://github.com/rust-lang/rust` 
*   然后`cd rust && git submodule update --init`

### 2.修改配置文件
*   在源码树的根目录创建或修改`config.toml`，内容如下
```toml
changelog-seen = 2
[build]
docs = false
host = ["loongarch64-unknown-linux-gnu"]
target = ["loongarch64-unknown-linux-gnu","x86_64-unknown-linux-gnu"] #后面那个好像不需要。。。

#nightly build must be used
rustc = "/home/coa/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/rustc"
cargo = "/home/coa/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/cargo"
rustfmt = "/home/coa/.rustup/toolchains/nightly-x86_64-unknown-linux-gnu/bin/rustfmt"

# Enable a build of the extended Rust tool set which is not only the compiler
# but also tools such as Cargo. 
extended = true
# Turn this off if you just want rustc -- CoA

tools = [    
   "cargo",    
   "clippy",    # I doubt if we need those three... -- CoA
   "rust-analyzer",
   "analysis",
]

[target.loongarch64-unknown-linux-gnu]  # Change this if you need. (obviously) -- CoA
cc = "/home/coa/CROSS/opt/cross/bin/loongarch64-unknown-linux-gnu-gcc"
cxx = "/home/coa/CROSS/opt/cross/bin/loongarch64-unknown-linux-gnu-g++"
ar = "/home/coa/CROSS/opt/cross/bin/loongarch64-unknown-linux-gnu-ar"
ranlib = "/home/coa/CROSS/opt/cross/bin/loongarch64-unknown-linux-gnu-ranlib"
linker = "/home/coa/CROSS/opt/cross/bin/loongarch64-unknown-linux-gnu-gcc"


[llvm]
download-ci-llvm = false
ccache = true  # 除非你确信真的只需要编译一次，将来也不打算换个rustc版本再试。否则最好还是保持打开的好
targets = "LoongArch;X86"  # This will save a lot of time   -- CoA
experimental-targets = ""  
```
### 3.打补丁
#### 1.Cargo
*   在src/tools/cargo/Cargo.toml末尾，增加
```toml
[patch.crates-io]
rustix = { git = 'https://github.com/FurryAcetylCoA/rustix.git' }  #这个补丁用了一个挺脏的方式，将来要想办法解决，才能合并主线，但现在我仅仅是让他能通过编译。详询CoA，这里地方太小，写不下
```
*   然后在同一个文件夹下运行`cargo update -p rustix`


### 4.开始编译
*   `./x build`
    *  如果在编译llvm阶段找不到_POSIX_ARG_MAX，就手动替换成4096.懒得找根本原因了。。。
*   `./x dist`
*   在build/dist里获取打包好的安装文件，选择`rust-<版本号>`开头的那个压缩包即可
